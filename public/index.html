<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chat Fun | Premium Final</title>
    <style>
        /* Theme Variables */
        :root { --accent: #4facfe; --bg: #050810; --glass: rgba(255,255,255,0.05); --text: #fff; --card: #1e293b; }
        body.ghibli { --accent: #859900; --bg: #fdf6e3; --glass: rgba(255,255,255,0.8); --text: #586e75; --card: #eee8d5; }

        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100dvh; overflow: hidden; transition: 0.5s ease; }
        .view { height: 100dvh; width: 100vw; position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s ease; }
        .hidden { transform: translateY(50px); opacity: 0; pointer-events: none; }
        
        .glass { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 35px; width: 92%; max-width: 400px; text-align: center; }
        .input-group { margin-bottom: 12px; text-align: left; width: 100%; }
        label { font-size: 0.7rem; color: var(--accent); margin-left: 5px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 14px; background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.1); border-radius: 14px; color: var(--text); font-size: 16px; outline: none; box-sizing: border-box; margin-top: 4px; }
        
        .btn { width: 100%; padding: 18px; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; }
        .primary { background: var(--accent); color: #fff; }

        /* Animation & UI */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #theme-toggle { position: absolute; top: 15px; left: 15px; background: var(--glass); border: none; padding: 10px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; z-index: 20; }
        #new-chat-btn { position: absolute; top: 12px; right: 15px; background: var(--accent); color: #fff; border: none; padding: 8px 15px; border-radius: 10px; font-weight: bold; font-size: 0.75rem; cursor: pointer; z-index: 10; }
        
        #chat-win { flex: 1; width: 100%; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 18px; border-radius: 20px; max-width: 80%; word-wrap: break-word; }
        .me { background: var(--accent); color: #fff; align-self: flex-end; }
        .stranger { background: var(--card); align-self: flex-start; }
        .chat-img { max-width: 100%; border-radius: 12px; display: block; margin-top: 5px; }
        
        #link-display { background: var(--card); padding: 10px; border-radius: 12px; margin: 10px; font-size: 0.8rem; display: none; align-items: center; gap: 10px; }
        footer { margin-top: 25px; font-size: 0.75rem; opacity: 0.6; display: flex; gap: 15px; justify-content: center; }
        footer a { color: var(--accent); text-decoration: none; }
        .gender-tag { font-size: 0.7rem; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 20px; vertical-align: middle; margin-left: 5px; }
    </style>
</head>
<body>

    <button id="theme-toggle" onclick="toggleTheme()">üåô</button>

    <div id="v-land" class="view">
        <div class="glass">
            <h1 style="margin-bottom:25px">Chat <span style="color:var(--accent)">Fun</span></h1>
            <button class="btn primary" onclick="startMode('stranger')" style="margin-bottom:12px">Stranger Chat</button>
            <button class="btn" style="background:var(--glass); color:var(--text); margin-bottom:12px" onclick="startMode('host')">Host Multi-Room</button>
            <button class="btn" style="background:var(--glass); color:var(--text)" onclick="startMode('join')">Join via Link</button>
            <footer><a href="/LICENSE.txt" target="_blank">License</a><a href="/privacy.txt" target="_blank">Privacy</a><a href="/terms.txt" target="_blank">Terms</a></footer>
        </div>
    </div>

    <div id="v-set" class="view hidden">
        <div class="glass">
            <h2>Your Profile</h2>
            <div class="input-group"><label>Alias</label><input id="in-n" placeholder="Nickname"></div>
            <div style="display:flex; gap:10px;">
                <div class="input-group" style="flex:1"><label>Age (12-90)</label><input id="in-a" type="number"></div>
                <div class="input-group" style="flex:1"><label>Gender</label><select id="in-g"><option>Male</option><option>Female</option></select></div>
            </div>
            <div class="input-group"><label>City</label><input id="in-c" placeholder="City"></div>
            <div class="input-group"><label>Bio</label><textarea id="in-b" rows="2"></textarea></div>
            <div id="room-box" style="display:none; margin-bottom:12px;"><input id="in-r" placeholder="Room ID"></div>
            <button class="btn primary" onclick="submitProfile()">Continue</button>
        </div>
    </div>

    <div id="v-chat" class="view hidden">
        <button id="new-chat-btn" onclick="startNewStrangerChat()">New Chat</button>
        <div id="bar" style="width:100%; padding:12px; background:var(--glass); display:flex; align-items:center; justify-content:center; gap:10px; border-bottom:1px solid rgba(0,0,0,0.05);">
            <div id="spin" class="loader"></div><span id="btxt">Connecting...</span>
        </div>
        <div id="link-display"><span id="room-url" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1;"></span><button onclick="copyLink()" style="background:var(--accent); border:none; padding:5px 10px; border-radius:5px; color:white; font-size:0.7rem; font-weight:bold;">Copy</button></div>
        <div id="chat-win"></div>
        <div style="padding:15px; width:100%; background:var(--glass); display:flex; gap:10px; align-items:center;">
            <button onclick="document.getElementById('f').click()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">üñºÔ∏è</button>
            <input id="m" placeholder="Type..." style="flex:1; margin:0;">
            <button onclick="send()" class="btn primary" style="width:80px; padding:12px;">Send</button>
        </div>
        <input type="file" id="f" accept="image/*" style="display:none" onchange="handleFile()">
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let mode = '', prof = JSON.parse(sessionStorage.getItem('p'));

        function pulse(p) { if ("vibrate" in navigator) navigator.vibrate(p); }

        function toggleTheme() {
            document.body.classList.toggle('ghibli');
            const isG = document.body.classList.contains('ghibli');
            document.getElementById('theme-toggle').textContent = isG ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isG ? 'ghibli' : 'midnight');
        }
        if(localStorage.getItem('theme') === 'ghibli') toggleTheme();

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('room')) { document.getElementById('in-r').value = urlParams.get('room'); startMode('join'); }
        };

        function startMode(m) {
            mode = m;
            if(m === 'host' || m === 'join') document.getElementById('room-box').style.display = 'block';
            if(prof) submitProfile(); else move('v-set');
        }

        function submitProfile() {
            if(!prof) {
                const age = parseInt(document.getElementById('in-a').value);
                if(age < 12 || age > 90) return alert("Age 12-90 only.");
                prof = { name: document.getElementById('in-n').value, age, city: document.getElementById('in-c').value, bio: document.getElementById('in-b').value, gender: document.getElementById('in-g').value };
                sessionStorage.setItem('p', JSON.stringify(prof));
            }
            move('v-chat');
            const rid = document.getElementById('in-r').value || Math.random().toString(36).substring(7);
            if(mode === 'stranger') socket.emit('find-stranger', prof);
            else {
                socket.emit('join-room', { roomID: rid, profile: prof });
                const link = window.location.origin + "?room=" + rid;
                document.getElementById('link-display').style.display = 'flex';
                document.getElementById('room-url').textContent = link;
            }
        }

        // CORRECTED IMAGE HANDLER
        function handleFile() {
            const file = document.getElementById('f').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = { type: 'image', content: e.target.result };
                socket.emit('media-msg', data);
                displayMedia(data, 'me');
            };
            reader.readAsDataURL(file);
        }

        function displayMedia(d, s) {
            const div = document.createElement('div'); div.className = `msg ${s}`;
            div.innerHTML = `<img src="${d.content}" class="chat-img">`;
            const w = document.getElementById('chat-win'); w.appendChild(div); w.scrollTop = w.scrollHeight;
        }

        function copyLink() { navigator.clipboard.writeText(document.getElementById('room-url').textContent).then(() => alert("Link Copied!")); }

        function startNewStrangerChat() {
            socket.emit('leave-chat');
            document.getElementById('chat-win').innerHTML = '';
            document.getElementById('spin').style.display = 'block';
            document.getElementById('btxt').textContent = "Connecting...";
            socket.emit('find-stranger', prof);
        }

        function send() {
            const i = document.getElementById('m');
            if(i.value) { socket.emit('chat-msg', { text: i.value, name: prof.name }); addMsg(i.value, 'me'); i.value=''; }
        }

        function addMsg(t, s) {
            const div = document.createElement('div'); div.className = `msg ${s}`; div.textContent = t;
            const w = document.getElementById('chat-win'); w.appendChild(div); w.scrollTop = w.scrollHeight;
        }

        function move(id) { document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        document.getElementById('m').addEventListener('keypress', (e) => { if(e.key === 'Enter') send(); });

        socket.on('user-connected', (data) => {
            pulse(200);
            document.getElementById('spin').style.display = 'none';
            const p = data.partner;
            document.getElementById('btxt').innerHTML = `${p.name} Connected <span class="gender-tag">${p.gender}</span>`;
            addMsg(`System: Connected to ${p.name} (${p.age}) from ${p.city}.`, 'stranger');
        });

        socket.on('chat-msg', (d) => { pulse(100); addMsg(`${d.name}: ${d.text}`, 'stranger'); });
        socket.on('media-msg', (d) => { pulse(150); displayMedia(d, 'stranger'); });
        socket.on('user-left', (n) => { addMsg(`${n} has left.`, 'stranger'); document.getElementById('btxt').textContent = "Disconnected"; });
    </script>
</body>
</html>
